#ansible playbook file for orion setup
#pre-requisites for the orion setup
- name: install the make, cmake 
  yum:
    name: make ,cmake ,gcc-c++ ,scons, boost-devel, libcurl-devel, gnutls-devel, libgcrypt-devel, openssl-devel, libuuid-devel, cyrus-sasl-devel, bzip2 , git
    state: present
  become: yes
  tags:
  - orion

#create directory
- name: ansible create directory
  file:
      path: /etc/orion
      state: directory
  become: yes
  tags:
  - orion



#mongo driver installation
- name: install mongo-driver 
  get_url:
    url: https://github.com/mongodb/mongo-cxx-driver/archive/legacy-1.1.2.tar.gz
    dest: /etc/orion/legacy-1.1.2.tar.gz
    mode: '0440'
  become: yes
  tags:
  - orion


#unzipping the mongo tar 
- name: Extract legacy-1.1.2.tar.gz into /etc/foo
  unarchive:
    src: /etc/orion/legacy-1.1.2.tar.gz
    dest: /etc/orion
    remote_src: yes
  become: yes
  tags:
  - orion


#run the scons in the mongo folder 
- name: Go to the folder and run scons ssl
  command: sudo scons  --use-sasl-client --ssl
  args:
    chdir: /etc/orion/mongo-cxx-driver-legacy-1.1.2
  become: yes
  tags:
  - orion


#run the scons install in the mongo folder 
- name: Go to the folder and run scons install
  command: sudo scons install --prefix=/usr/local --use-sasl-client --ssl
  args:
    chdir: /etc/orion/mongo-cxx-driver-legacy-1.1.2
  become: yes
  tags:
  - orion


#rapidjson package installation 
- name: install rapidjson 
  get_url:
    url: https://github.com/miloyip/rapidjson/archive/v1.0.2.tar.gz
    dest: /etc/orion/v1.0.2.tar.gz
  become: yes
  tags:
  - orion


#unzipping the rapidjson tar 
- name: Extract rapidjson-1.0.2 into /etc/foo
  unarchive:
    src: /etc/orion/v1.0.2.tar.gz
    dest: /etc/orion
    remote_src: yes
  become: yes
  tags:
  - orion

#removing the older rapidjson package
- name: move rapid json
  command: rm -rf /usr/local/include/rapidjson
  become: yes
  tags:
  - orion


#move the newer rapidjson to /usr/local/include
- name: move rapid json
  command: mv /etc/orion/rapidjson-1.0.2/include/rapidjson /usr/local/include
  become: yes
  tags:
  - orion



#libmicrohttpd package installation
- name: install libmircohttpd
  get_url:
    url: http://ftp.gnu.org/gnu/libmicrohttpd/libmicrohttpd-0.9.48.tar.gz
    dest: /etc/orion
    mode: '0440'
  become: yes
  tags:
  - orion


#unzipping the libmicrohttpd tar
- name: Extract libmicrohttpd-0.9.48.tar.gz into /etc/foo
  unarchive:
    src: /etc/orion/libmicrohttpd-0.9.48.tar.gz
    dest: /etc/orion
    remote_src: yes
  become: yes
  tags:
  - orion


#run the ./configure command 
- name: run the ./configure command 
  command: ./configure --disable-messages --disable-postprocessor --disable-dauth
  args:
    chdir: /etc/orion/libmicrohttpd-0.9.48
  become: yes
  tags:
  - orion


#run the make command 
- name: run the make command 
  command: make
  args:
    chdir: /etc/orion/libmicrohttpd-0.9.48
  become: yes
  tags:
  - orion



#run the make install command 
- name: run the make install command
  command: make install
  args:
    chdir: /etc/orion/libmicrohttpd-0.9.48
  become: yes
  tags:
  - orion



#run the ldconfig command 
- name: run the ldconfig command 
  command: sudo ldconfig
  args:
    chdir: /etc/orion/libmicrohttpd-0.9.48
  become: yes
  tags:
  - orion



#gmock package installation
- name: install gmock 
  get_url:
    url: https://nexus.lab.fiware.org/repository/raw/public/storage/gmock-1.5.0.tar.bz2
    dest: /etc/orion
    mode: '0440'
  become: yes
  tags:
  - orion


#unzipping the gmock tar
- name: Extract gmock-1.5.0.tar.bz2 into /etc/foo
  command: tar -xvjf gmock-1.5.0.tar.bz2
  args:
    chdir: /etc/orion
  become: yes
  tags:
  - orion


#run the ./configure command 
- name: run the ./configure command
  command: ./configure
  args:
    chdir: /etc/orion/gmock-1.5.0
  become: yes
  tags:
  - orion



#run the make command 
- name: run the make command
  command: make
  args:
    chdir: /etc/orion/gmock-1.5.0
  become: yes
  tags:
  - orion



#run the make install commad 
- name: run the make install command
  command: make install
  args:
    chdir: /etc/orion/gmock-1.5.0
  become: yes
  tags:
  - orion


#run the ldconfig command 
- name: run the ldconfig command 
  command: sudo ldconfig
  args:
    chdir: /etc/orion/gmock-1.5.0
  become: yes
  tags:
  - orion


#Get the fiware-orion code from git
- git:
    repo: 'https://github.com/telefonicaid/fiware-orion'
    dest: /etc/fiware
    clone: yes
    update: yes
  become: yes
  tags:
  - orion
    

#run the make command 
- name: run the make command 
  command: make
  args:
    chdir: /etc/fiware
  become: yes
  tags:
  - orion


#Install the binary.Use INSTALL_DIR to set the installation prefix path (default is /usr), thus the broker is installed in $INSTALL_DIR/bin directory.
- name: set the installation prefix path
  command: sudo make install INSTALL_DIR=/usr
  args:
    chdir: /etc/fiware
  become: yes
  tags:
  - orion

